From 19418e4cc6b2577520fb67f5a8422bc6629bf7a7 Mon Sep 17 00:00:00 2001
From: Ikey Doherty <ikey@solus-project.com>
Date: Sun, 3 Dec 2017 12:08:08 +0000
Subject: [PATCH] Add new migration for the 'fuse' group

All active/admin users should be in the `fuse` group by default, and this
didn't happen a long time ago in Solus. This migration automatically moves
older installations to support the fuse group.

Signed-off-by: Ikey Doherty <ikey@solus-project.com>
---
 src/cli/migrate.c              |  1 +
 src/meson.build                |  1 +
 src/migrations/05_fuse_group.c | 37 +++++++++++++++++++++++++++++++++++++
 src/migrations/declared.h      |  1 +
 4 files changed, 40 insertions(+)
 create mode 100644 src/migrations/05_fuse_group.c

diff --git a/src/cli/migrate.c b/src/cli/migrate.c
index cda99c8..2a1f320 100644
--- a/src/cli/migrate.c
+++ b/src/cli/migrate.c
@@ -46,6 +46,7 @@ static QolMigration migration_table[] = {
         REVOKED_MIGRATION("musl didn't understand stateless"),
         MIGRATION("Set static gid for 'users' group", 03_users_group_gid),
         MIGRATION("Add users to 'users' group", 04_users_group_join),
+        MIGRATION("Add users to fuse group", 05_fuse_group),
 };
 
 /**
diff --git a/src/meson.build b/src/meson.build
index f107695..031f2e8 100644
--- a/src/meson.build
+++ b/src/meson.build
@@ -22,6 +22,7 @@ migrations = [
     '02_plugdev_group',
     '03_users_group_gid',
     '04_users_group_join',
+    '05_fuse_group',
 ]
 
 # Insert into sources
diff --git a/src/migrations/05_fuse_group.c b/src/migrations/05_fuse_group.c
new file mode 100644
index 0000000..081e3b9
--- /dev/null
+++ b/src/migrations/05_fuse_group.c
@@ -0,0 +1,37 @@
+/*
+ * This file is part of qol-assist.
+ *
+ * Copyright Â© 2017 Solus Project
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ */
+
+#define _GNU_SOURCE
+
+#include <stdio.h>
+
+#include "declared.h"
+
+/**
+ * Add all active/admin users into the fuse group
+ */
+bool qol_migration_05_fuse_group(QolContext *context)
+{
+        return qol_migration_push_active_admin_group(context, "fuse");
+}
+
+/*
+ * Editor modelines  -  https://www.wireshark.org/tools/modelines.html
+ *
+ * Local variables:
+ * c-basic-offset: 8
+ * tab-width: 8
+ * indent-tabs-mode: nil
+ * End:
+ *
+ * vi: set shiftwidth=8 tabstop=8 expandtab:
+ * :indentSize=8:tabSize=8:noTabs=true:
+ */
diff --git a/src/migrations/declared.h b/src/migrations/declared.h
index 1b890fd..3095695 100644
--- a/src/migrations/declared.h
+++ b/src/migrations/declared.h
@@ -52,6 +52,7 @@ bool qol_migration_01_scanner_group(QolContext *context);
 bool qol_migration_02_plugdev_group(QolContext *context);
 bool qol_migration_03_users_group_gid(QolContext *context);
 bool qol_migration_04_users_group_join(QolContext *context);
+bool qol_migration_05_fuse_group(QolContext *context);
 
 /*
  * Editor modelines  -  https://www.wireshark.org/tools/modelines.html
-- 
2.15.1

